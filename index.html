<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="">
        <title>Stegamsg</title>
        <!-- Bootstrap core CSS -->
        <link href="bootstrap-4.0.0-beta/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Custom styles for this template -->
        <link href="/style.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <link rel="stylesheet" href="//cdn.materialdesignicons.com/2.0.46/css/materialdesignicons.min.css">
    </head>
    <body>
        <nav class="navbar navbar-light gradient fixed-top">
            <form class="form-inline my-2 my-lg-0">
                <div class="input-group">
                    <input type="text" class="form-control" id="groupcode" placeholder="Group Code">
                    <div class="input-group-btn">
                        <button id="dropdown1" type="button" onclick="submit()" class="btn btn-secondary"><i class="mdi mdi-check-circle-outline"></i></button>
                        <button style="height:2.45em" type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="sr-only">Toggle dropdown</span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" onclick="function2()">Join a group</a>
                            <a class="dropdown-item" onclick="function1()">Create a group</a>
                        </div>
                    </div>
                </div>
            </form>
            <a class="navbar-brand">Stegamsg</a>
        </nav>
        <script>
            var a = 1;
            function function1() {
                a = 2
                $("#dropdown1").html("<i class=\"mdi mdi-plus-circle-outline\"></i>")
            }
            function function2() {
                a = 1
                $("#dropdown1").html("<i class=\"mdi mdi-check-circle-outline\"></i>")
            }
            
            function submit() {
                document.cookie = "tempcookie=" + $("#groupcode").val();
                document.cookie = "tempcookie2=" + a
              
                if (a == 2) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            document.getElementById("demo").innerHTML = this.responseText;
                        }
                    };
                    xhttp.open("POST", "/new", true);
                    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                    xhttp.send("fname=Henry&lname=Ford");
                }
                window.location = "/";
            }
        </script>
        <div class="content-view">
            <div class="d-flex flex-column">
                <div id="canvases"></div>
            </div>
            <div class="footer navbar fixed-bottom">
                <input type="text" class="form-control align-bottom" placeholder="Enter a message..." id="textbox"></input>
            </div>

        </div>

        <!-- bootstrap  stuff -->
        <script>window.jQuery || document.write('<script src="bootstrap-4.0.0-beta/assets/js/vendor/jquery.min.js"><\/script>')</script>
        <script src="bootstrap-4.0.0-beta/assets/js/vendor/popper.min.js"></script>
        <script src="bootstrap-4.0.0-beta/dist/js/bootstrap.min.js"></script>
        <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
        <script src="bootstrap-4.0.0-beta/assets/js/ie10-viewport-bug-workaround.js"></script>

        <!-- scripts to communicate with node -->
        <script src="lsbtools.min.js"></script>
        <script>
            function getDataFromImage(imageName, key, callback_) {
                var image = new Image();
                
                image.onload = function() {
                    canvas = document.createElement('canvas')
                    context = canvas.getContext('2d')
                    
                    canvas.width = image.width;
                    canvas.height = image.height;
                    context.drawImage(image, 0, 0, canvas.width, canvas.height);
                    imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    pixels = imageData['data'];
                    options = {
                        shuffle: true, // spread data across image instead of writing sequentially
                        matrix: true, // use matrix encoding to minimize changes
                        mask: true, // mask data with stream of random bytes
                        key: key, // array of bytes used as key for shuffling and masking
                        pm1code: true  // use Â±1 encoding instead of LSB flip
                    };
                    
                    message = lsbTools.read(pixels, options)
                    messageString = ""
                    
                    for (x = 0; x < message.length; ++x)
                        messageString += String.fromCharCode(message[x])

                    // now redraw with better dimensions
                    var ratio = image.height / image.width;
                    canvas.width = window.innerWidth / 3 ;
                    canvas.height = ratio * canvas.width;
                    context.drawImage(image, 0, 0, canvas.width, canvas.height);

                    callback_({"Text":messageString, "Canvas":canvas});
                }
                
                image.src = imageName;
            };
        </script>

        <script>
            var socket = io.connect('/');
            
            socket.on('in', function (fileName) {
                getDataFromImage(fileName, [1, 2, 3, 4, 5, 6, 7, 8, 9, 0], function(data) {
                    $("#canvases").append("<div class=\"gradient message\" data-toggle=\"tooltip\"></div>");
                    $("#canvases div:last-child").attr('title', data['Text']);
                    var d = new Date();
                    var dstr = "Sent at: " + d.getHours() + ":" + d.getMinutes();
                    $("#canvases div:last-child").append("<p class=\"msg-timestamp\">" + dstr + "</p>");
                    $("#canvases div:last-child").append(data['Canvas']);
                    $('html, body').animate({scrollTop: $('#canvases').height()}, 1000);
                });
            });
            
            $('#textbox').keyup(function(e) {
                if(e.keyCode == 13) {
                    socket.emit('out', $("#textbox").val());
                    $("#textbox").val("");
                }
            });
        </script>
    </body>
</html>

