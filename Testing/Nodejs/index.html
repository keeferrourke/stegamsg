<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="stylesheet" href="/game.css">


<div id="canvases"></div>
<body>
<input id="textbox"></input>
</body>

<script src="lsbtools.min.js"></script>
<script>
    function getDataFromImage(imageName, key, callback_)
    {
        var image = new Image();
        
        image.onload = function() {
            canvas = document.createElement('canvas')
            context = canvas.getContext('2d')
            
            canvas.width = image.width;
            canvas.height = image.height;
            context.drawImage(image, 0, 0, canvas.width, canvas.height);
            imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            
            pixels = imageData['data'];
            options = {
                shuffle: true, // spread data across image instead of writing sequentially
                matrix: true, // use matrix encoding to minimize changes
                mask: true, // mask data with stream of random bytes
                key: key, // array of bytes used as key for shuffling and masking
                pm1code: true  // use Â±1 encoding instead of LSB flip
            };
            
            message = lsbTools.read(pixels, options)
            
            messageString = ""
            
            for (x = 0; x < message.length; ++x)
                messageString += String.fromCharCode(message[x])
            
            callback_({"Text":messageString, "Canvas":canvas});
        }
        
        image.src = imageName;
    };

</script>

<script>
    var socket = io.connect('/');
    
    socket.on('news', function (data) {
        console.log(data);
        
        $("#chat").append(JSON.stringify(data));
    });
    
    socket.on('in', function (fileName) {
        getDataFromImage(fileName, [1, 2, 3, 4, 5, 6, 7, 8, 9, 0], function(data) {
            $("#canvases").append(data['Canvas']);
            $("#canvases").append(data['Text']);
        });
    });
    
    $('#textbox').keyup(function(e){
        if(e.keyCode == 13)
        {
            socket.emit('out', $("#textbox").val());
            $("#textbox").val("");
        }
    });
</script>
